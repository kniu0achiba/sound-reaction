<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>åå¿œãƒ†ã‚¹ãƒˆï¼šéŸ³ãŒé³´ã£ãŸã‚‰é›¢ã™</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827cc; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; --err:#f87171;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
    "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;
    background: radial-gradient(1200px 600px at 10% 0%, #0b122b 0%, #0f172a 40%, #0a0f22 100%);
    color:var(--ink); min-height:100svh; display:grid; place-items:center; padding:24px;
  }
  .app{
    width:min(780px,100%); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px; box-shadow:var(--shadow);
    backdrop-filter: blur(6px);
  }
  h1{margin:0 0 6px; font-size:clamp(20px, 3.5vw, 28px)}
  .subtitle{color:var(--muted); margin-bottom:16px}
  .stage{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px;
    padding:24px; border-radius:12px; background:var(--card); border:1px solid rgba(255,255,255,.08);
  }
  .big-btn{
    appearance:none; border:none; border-radius:999px; padding:18px 28px; font-weight:800; font-size:18px; cursor:pointer;
    color:#061017; background:linear-gradient(180deg, var(--accent), #14b8c5); box-shadow:0 10px 24px rgba(20,184,197,.35);
    min-width:260px;
  }
  .big-btn:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}
  .status{min-height:24px; font-weight:800}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
  .badges{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:14px}
  .badge{padding:6px 10px; border-radius:999px; background:#0b1023; border:1px solid rgba(255,255,255,.12)}
  .help{font-size:14px; color:var(--muted)}
  .footer{margin-top:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px}
</style>
</head>
<body>
<main class="app" role="application" aria-labelledby="title">
  <h1 id="title">åå¿œãƒ†ã‚¹ãƒˆï¼šéŸ³ãŒé³´ã£ãŸã‚‰é›¢ã™</h1>
  <div class="subtitle">ãƒœã‚¿ãƒ³ã‚’<strong>æŠ¼ã—ç¶šã‘</strong>ã€<strong>éŸ³ãŒé³´ã£ãŸã‚‰é›¢ã™</strong>ã€‚éŸ³ãŒé³´ã£ã¦ã‹ã‚‰é›¢ã™ã¾ã§ã®æ™‚é–“ã‚’è¨ˆæ¸¬ã—ã¾ã™ï¼ˆéŸ³ã®ç¬é–“ã¯ç”»é¢ã«å¤‰åŒ–ãªã—ï¼‰ã€‚</div>

  <section class="stage" aria-label="ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸">
    <!-- ç”»é¢ä¸Šã®è¦–è¦šåˆå›³ã¯ä¸€åˆ‡å‡ºã•ãªã„ -->
    <div class="row">
      <button id="holdBtn" class="big-btn" aria-pressed="false">æŠ¼ã—ç¶šã‘ã¦ãã ã•ã„ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¯ï¼‰</button>
      <button id="retryBtn" class="big-btn" style="background:linear-gradient(180deg, #c6d3ff, #9fb3ff);" disabled>ã‚‚ã†ä¸€åº¦</button>
    </div>
    <div id="msg" class="status" aria-live="polite"></div>
    <div class="badges">
      <span class="badge" id="bestLabel">ãƒ™ã‚¹ãƒˆ: â€”</span>
      <span class="badge" id="lastLabel">å‰å›: â€”</span>
      <span class="badge" id="trialLabel">è©¦è¡Œ: 0</span>
    </div>
    <div class="help">â€» é…å»¶ã¯ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆç´„1.5ã€œ4ç§’ï¼‰ã€‚éŸ³ã®å‰ã«é›¢ã™ã¨ã€Œãƒ•ãƒ©ã‚¤ãƒ³ã‚°ã€ã€‚</div>
  </section>

  <div class="footer">
    <span class="help">Made by å‹å·±</span>
    <span class="help">ã‚¹ãƒãƒ›ï¼šé•·æŠ¼ã—ï¼PCï¼šãƒã‚¦ã‚¹é•·æŠ¼ã—ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼</span>
  </div>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const holdBtn = $('#holdBtn');
  const retryBtn = $('#retryBtn');
  const msg = $('#msg');
  const bestLabel = $('#bestLabel'), lastLabel = $('#lastLabel'), trialLabel = $('#trialLabel');

  // ===== ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆ<audio>ï¼‰ã¨è‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾ç­– =====
  // ç´„100msãƒ»880Hzã®çŸ­ã„WAVï¼ˆBase64ï¼‰
  // å…ˆé ­ç„¡éŸ³ãªã—ãƒ»å³é ­ã‹ã‚‰é³´ã‚‹ãƒ–ã‚¶ãƒ¼ï¼ˆ1kHz / ç´„120ms / WAV 16-bit PCM, mono, 44.1kHzï¼‰
  // ===== Web Audioï¼ˆãƒ–ã‚¶ãƒ¼åˆæˆãƒ»å…ˆé ­ç„¡éŸ³ãªã—ãƒ»å³ç™ºéŸ³ï¼‰ =====
  let audioCtx = null;
  let masterGain = null;

  // AudioContext æº–å‚™
  function ensureAudioContext(){
    if(!audioCtx){
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return;
      audioCtx = new AC();

      // ãƒã‚¹ã‚¿ãƒ¼ã‚²ã‚¤ãƒ³ï¼ˆéŸ³é‡ï¼‰ã‚’ç”¨æ„ã—ã¦ãŠãï¼ˆæ—¢å®šã‚„ã‚„å¤§ãã‚ï¼‰
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.6; // â† éŸ³é‡ï¼ˆ0.0ã€œ1.0ï¼‰ã€‚å¤§ãã™ãã‚‹å ´åˆã¯ä¸‹ã’ã¦ãã ã•ã„
      masterGain.connect(audioCtx.destination);
    }
    if(audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  // æŠ¼ã—å§‹ã‚ã§â€œè§£éŒ â€ï¼ˆè‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾ç­–ï¼šç„¡éŸ³ã‚’ä¸€ç¬é³´ã‚‰ã™ï¼‰
  async function unlockAudio(){
    ensureAudioContext();
    if(!audioCtx) return;
    try{
      const dur = 0.03; // 30ms
      const sr = audioCtx.sampleRate || 44100;
      const buf = audioCtx.createBuffer(1, Math.ceil(dur*sr), sr); // ç„¡éŸ³
      const src = audioCtx.createBufferSource();
      src.buffer = buf;
      src.connect(masterGain);
      src.start();
      await new Promise(r => setTimeout(r, 40));
    }catch(e){ /* noop */ }
  }

  // ãƒ–ã‚¶ãƒ¼æœ¬ä½“ï¼šsquareæ³¢ 1000Hz / 120msï¼ˆå…ˆé ­ç„¡éŸ³ãªã—ãƒ»å³é³´å‹•ï¼‰
  function playBeep(){
    ensureAudioContext();
    if(!audioCtx) return;

    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    // éŸ³è‰²ãƒ»é«˜ã•
    osc.type = 'square';         // ãƒ–ã‚¶ãƒ¼ã£ã½ã„è§’æ³¢
    osc.frequency.setValueAtTime(1000, t0); // 1kHzï¼ˆèãå–ã‚Šã‚„ã™ã„ï¼‰

    // ã‚¯ãƒªãƒƒã‚¯éŸ³æŠ‘åˆ¶ã®ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆå…ˆé ­ã‹ã‚‰éŸ³ãŒå‡ºã‚‹ãŒç ´è£‚éŸ³ã¯æ¸›ã‚‰ã™ï¼‰
    const attack = 0.004;              // 4ms
    const durationSec = 0.12;          // 120ms
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.9, t0 + attack); // ã™ãç«‹ã¡ä¸Šã’ï¼ˆâ‰’å³é³´å‹•ï¼‰
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + durationSec);

    // ãƒã‚¹ã‚¿ãƒ¼ã¸
    osc.connect(gain).connect(masterGain);
    osc.start(t0);
    osc.stop(t0 + durationSec + 0.02);
  }

  // ===== æ¸¬å®šçŠ¶æ…‹ =====
  const BEST_KEY = 'reaction-sound-best';
  let best = parseInt(localStorage.getItem(BEST_KEY) || '0', 10) || null;
  let trials = 0;

  let holding = false;   // ã„ã¾æŠ¼ã—ç¶šã‘ã¦ã„ã‚‹ã‹
  let sounded = false;   // éŸ³ãŒé³´ã£ãŸã‹
  let timerId = null;    // ãƒ©ãƒ³ãƒ€ãƒ é…å»¶ã‚¿ã‚¤ãƒãƒ¼
  let startTime = 0;     // éŸ³ãŒé³´ã£ãŸç¬é–“ï¼ˆperformance.nowï¼‰
  let last = null;       // ç›´è¿‘ã®è¨˜éŒ²ï¼ˆmsï¼‰

  function updateBadges(){
    bestLabel.textContent = 'ãƒ™ã‚¹ãƒˆ: ' + (best ? (best + ' ms') : 'â€”');
    lastLabel.textContent = 'å‰å›: ' + (last != null ? (last + ' ms') : 'â€”');
    trialLabel.textContent = `è©¦è¡Œ: ${trials}`;
  }

  function flash(text, kind){
    // â€» éŸ³ã®ç¬é–“ã¯å‘¼ã°ãªã„ï¼ˆè¦–è¦šå¤‰åŒ–ç¦æ­¢ï¼‰
    msg.textContent = text || '';
    msg.className = 'status' + (kind ? ' ' + kind : '');
  }

  function clearTimer(){
    if(timerId){ clearTimeout(timerId); timerId = null; }
  }

  function scheduleSound(){
    // 1.5ã€œ4.0ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ é…å»¶
    const delay = Math.random() * 2500 + 1500;
    timerId = setTimeout(()=>{
      // éŸ³ã®ç¬é–“ã¯UIæ›´æ–°ã—ãªã„
      sounded = true;
      startTime = performance.now();
      playBeep();
    }, delay);
  }

  function resetRound(){
    clearTimer();
    holding = false;
    sounded = false;
    flash('æŠ¼ã—ç¶šã‘ã‚‹ã¨ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚', '');
    holdBtn.setAttribute('aria-pressed','false');
    retryBtn.disabled = true;
  }

  function startHold(){
    if(holding) return;
    holding = true;
    holdBtn.setAttribute('aria-pressed','true');
    retryBtn.disabled = true;

    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè§£éŒ ï¼ˆWindows/Edge/Chromeã§ã‚‚å®‰å…¨å´ï¼‰
    unlockAudio();

    clearTimer();
    sounded = false;
    flash('éŸ³ãŒé³´ã‚‹ã¾ã§é›¢ã•ãªã„ã§ãã ã•ã„â€¦', '');
    scheduleSound();
  }

  function endHold(){
    if(!holding) return;
    holding = false;
    holdBtn.setAttribute('aria-pressed','false');
    clearTimer();

    if(!sounded){
      // ãƒ•ãƒ©ã‚¤ãƒ³ã‚°
      flash('ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ï¼ éŸ³ãŒé³´ã‚‹å‰ã«é›¢ã—ã¾ã—ãŸã€‚', 'err');
      retryBtn.disabled = false;
      return;
    }

    const rt = Math.round(performance.now() - startTime);
    last = rt;
    trials++;
    if(!best || rt < best){
      best = rt;
      localStorage.setItem(BEST_KEY, String(best));
      flash(`ğŸ‰ ${rt} msï¼ˆãƒ™ã‚¹ãƒˆæ›´æ–°ï¼ï¼‰`, 'ok');
    }else{
      flash(`${rt} ms`, 'ok');
    }
    retryBtn.disabled = false;
    updateBadges();
  }

  // åˆæœŸè¡¨ç¤º
  updateBadges();
  resetRound();

  // --- å…¥åŠ›ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆå…‰åˆå›³ç‰ˆã¨åŒã˜æ§‹æˆï¼‰ ---
  // å³ã‚¯ãƒªãƒƒã‚¯ç­‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ‘æ­¢ï¼ˆé•·æŠ¼ã—ã®é‚ªé­”é˜²æ­¢ï¼‰
  document.addEventListener('contextmenu', e => e.preventDefault());

  // ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
  window.addEventListener('keydown', e=>{
    if(e.code === 'Space'){ e.preventDefault(); }
  }, {passive:false});

  // ãƒã‚¦ã‚¹
  holdBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); startHold(); });
  document.addEventListener('mouseup',   (e)=>{ if(holding) endHold(); });

  // ã‚¿ãƒƒãƒ
  holdBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startHold(); }, {passive:false});
  document.addEventListener('touchend',  (e)=>{ if(holding) endHold(); }, {passive:false});

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ï¼‰
  document.addEventListener('keydown', (e)=>{
    if(e.code === 'Space' && !holding){ startHold(); }
  });
  document.addEventListener('keyup', (e)=>{
    if(e.code === 'Space' && holding){ endHold(); }
  });

  // ã‚‚ã†ä¸€åº¦
  retryBtn.addEventListener('click', resetRound);
})();
</script>
</body>
</html>